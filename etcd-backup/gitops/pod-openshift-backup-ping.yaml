---
apiVersion: v1
kind: Pod
metadata:
  name: openshift-backup-test
  namespace: etcd-backup
spec:
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  containers:
    - name: backup
      image: regional-quay-quay.apps.hub.vimv2.ecocenter.fr/ocp-utils/backup-cli:latest
      command:
        - "/bin/bash"
        - "-c"
        - "while true; do sleep 1; done"
        - |
          #!/bin/bash
          while true; do
            time oc create secret 
            

          MASTER_NODE_IP=$(oc get nodes -l node-role.kubernetes.io/master -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')

          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /tmp/id_ed25519 core@$MASTER_NODE_IP 'sudo /usr/local/bin/cluster-backup.sh /tmp/backup-$(date +"%Y%m%d-%H%M%S") && sudo chown -R core:core /tmp/backup*'

          rsync -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /tmp/id_ed25519" -a --info=progress2 core@$MASTER_NODE_IP:/tmp/backup-* /backups

          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /tmp/id_ed25519 core@$MASTER_NODE_IP 'rm -rf /tmp/backup*'

          aws s3 ls s3://${BUCKET_NAME}/ --no-verify-ssl --endpoint-url https://$BUCKET_HOST:$BUCKET_PORT

          aws s3 sync /backups/ s3://$BUCKET_NAME/ --no-verify-ssl --endpoint-url https://$BUCKET_HOST:$BUCKET_PORT
      envFrom:
        - secretRef:
            name: s3-bucket-credentials
        - configMapRef:
            name: s3-bucket-credentials
      securityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        capabilities:
          drop:
            - ALL
      volumeMounts:
        - name: ssh-key-secret
          mountPath: /tmp
          readOnly: true
        - name: writable-ssh-key
          mountPath: /writable
  volumes:
    - name: ssh-key-secret
      secret:
        secretName: ssh-key-secret
    - name: writable-ssh-key
      emptyDir: {}
  restartPolicy: Never
  serviceAccountName: openshift-backup
